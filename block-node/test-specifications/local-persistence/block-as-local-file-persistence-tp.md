# E2E Test Plan - `BlockAsLocalFile Persistence`

## Overview

`BlockAsLocalFile Persistence` is a key component of the Block Node.
Mainly, it is responsible for storing and retrieving `Blocks` from a local
storage. It has several moving parts, like path resolution logic, writer tasks,
readers etc. which when combined, provide a robust and efficient way to store
and retrieve`Blocks`. This E2E test plan aims to highlight the key scenarios
that need to be tested for end results in order to ensure the correctness and
proper working of the `BlockAsLocalFile Persistence`.

## Key Considerations for `BlockAsLocalFile Persistence`

- **Path Resolution Logic**: `BlockAsLocalFile Persistence` relies on path
  resolution logic which determines the location of a given `Block`. Path
  resolution utilizes 3 roots: `unverified`,`live` and `archive`.
- **Trie Data Structure for Path Resolution**: `BlockAsLocalFile Persistence`
  utilizes a trie data structure to resolve paths for `Block`s. This is done to
  ensure that the path resolution is efficient and fast.
- **`unverfied` root path**: Initially all blocks are stored under the
  `unverified`. After verification on a given `Block` passes, the persisted
  `Block` is moved to the `live` root, essentially being _published_.
- **`live` root path**: This is the root path where all verified `Block`s are
  stored. `live` root path will only hold on to `Block`s for a limited time, as
  they are usually archived in groups, leaving behind only a link to the archive.
  Utilizing a link means that discoverability of a `Block` is still possible
  under the `live` root, no matter that a given file _might_ not be physically
  present there.
- **`archive` root path**: This is the root path where all locally archived
  `Block`s are stored. In groups of configurable size, `Block`s are archived,
  meaning that they are zipped and stored in the `archive` root. The `live` root
  will have a link to the zip file in place of where the parent directory of the
  group that was just archived would be (utilizing the trie structure)
- **Writer Tasks**: `BlockAsLocalFile Persistence` has writer tasks that are
  responsible for writing `Block`s to the local storage. These tasks are run
  in parallel and are
  non-blocking.
- **Persistence Response Codes**: `BlockAsLocalFile Persistence` publishes
  meaningful results at the end of each writer task. These codes are internal to
  the `Block Node` and any other service that might be interested in these
  codes, can receive them.

## Test Scenarios

> _**NOTE**: for the purpose of the below test definitions, we will have the
> following roots definitions (these could be configured to be different, but
> whatever they are configured to is of no relevance to the outcome of the
> tests, simply we need a reference point so an example could be shown):_
> - `unverified` root: `/unverified`
> - `live` root: `/live`
> - `archive` root: `/archive`
>
> _**NOTE**: assume that before each test no `Block` files are present,
> all distinct roots are empty unless specified otherwise._
>
> _**NOTE**: the trie structure for the `live` and `archive` root is resolving
> all the digits of a `long` (max. 19 digits). We have a single digit per node
> or directory up to a max. depth of 18, and then we have the full `BlockNumber`
> as the file name of any persisted block with all leading zeros for the `live`
> root and for the `archive` root we have a max. depth of
> `19 - (base 10 log of archiveGroupSize) - 1`, at which level we will find the
> zip file that will contain all entries (count of `archiveGroupSize`) that
> must be found for the zip. `archiveGroupSize` is the configurable amount of
> files that will be archived as a group (must be a pow of 10)._

|    Test Case ID | Test Name                                                                          | Scenario Description                                                                                                                                                                                                                                                                                                                                                                                                                                                           | Requirement                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Input                                                                                                                                                                                                                                                                                            | Output                                                                                                                                                                                                                                                                                                                                                   | Implemented (Y/N) |
|----------------:|:-----------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------:|
| E2ETC_BLFP_0001 | `Verify Location of Block Persisted Under Unverified Root`                         | `BlockAsLocalFile Persistence` will initially persist a `Block` under `unverified` root. We must make sure that the `Block` is indeed persisted in the proper location. For `unverified` root, `Block`s are stored directly under the root, no `trie` structure is utilized.                                                                                                                                                                                                   | Unverified `Block`s are persisted as files directly under the `unverified` root, without the use of the `trie` structure.                                                                                                                                                                                                                                                                                                                                                                                                                                    | Send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service.                                                                                                                                                                                                              | Regular file: `0000000000000012345.blk` with location: `/unverified/0000000000000012345.blk`.                                                                                                                                                                                                                                                            |         N         |
| E2ETC_BLFP_0002 | `Verify Content of Block Persisted Under Unverified Root`                          | `BlockAsLocalFile Persistence` will initially persist a `Block` under `unverified` root. We must make sure that the persisted `Block`'s content is indeed what we expect it to be (same as the content received through the `BlockStream` as input).                                                                                                                                                                                                                           | The persisted `Block`'s content is the same as the content that has been received as input.                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service.                                                                                                                                                                                                              | Content of persisted `Block` is the same as the one received via input.                                                                                                                                                                                                                                                                                  |         N         |
| E2ETC_BLFP_0003 | `Verify Overwritable Block Persisted Under Unverified Root`                        | `BlockAsLocalFile Persistence` will initially persist a `Block` under `unverified` root. Unverified `Block`s can be overwritten no matter the cause of the overwrite (a failed persistence, system restart or verification failure could potentially trigger a rewrite).                                                                                                                                                                                                       | Given that `Block` with `BlockNumber` 12345L is persisted as a file under the `unverified` root, verify that it can be overwritten, file content must be verified changed after an overwrite.                                                                                                                                                                                                                                                                                                                                                                | Ensure that `Block` with `BlockNumber`=12345L is persisted as file at `/unverified/0000000000000012345.blk` and is not published to `live` nor archived in `archive`, then send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service.                                   | `Block` persisted as file at `/unverified/0000000000000012345.blk` is overwritten with contents of the newly sent `Block` to the persistence service.                                                                                                                                                                                                    |         N         |
| E2ETC_BLFP_0004 | `Verify Cleanup for Failed Block Persistence Under Unverified Root`                | `BlockAsLocalFile Persistence` will initially persist a `Block` under `unverified` root. While the `Block` is still under the `unverified` root, if persistence or verification fails, a cleanup of the written file is expected.                                                                                                                                                                                                                                              | `Block` file and any data that may have resulted during a failed writing task must be cleaned up if persistence or verification fails.                                                                                                                                                                                                                                                                                                                                                                                                                       | Send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service.                                                                                                                                                                                                              | No file/data present under the `unverified` root that are result of a failed writing task.                                                                                                                                                                                                                                                               |         N         |
| E2ETC_BLFP_0005 | `Verify Discoverability of Block Persisted Under Unverified Root`                  | A `Block` that is persisted under the `unverified` root must not be discoverable (i.e. readable) as if it were available as data while the `Block` is still under the `unverified` root (essentially not yet published as available).                                                                                                                                                                                                                                          | Any `Block` that is persisted under the `unverified` root must not be discoverable (essentially visible as available) while it still resides under the `unverified` root.                                                                                                                                                                                                                                                                                                                                                                                    | Ensure that `Block` with `BlockNumber`=12345L is persisted as file at `/unverified/0000000000000012345.blk` and is not published to `live` nor archived in `archive`, then send `long` blockNumber=12345L as parameter to the block reader.                                                      | Block reader should return a not found status for the queried `Block`.                                                                                                                                                                                                                                                                                   |         N         |
| E2ETC_BLFP_0006 | `Verify Location of Block Persisted Under Unverified Root After Move to Live Root` | `BlockAsLocalFile Persistence` will move a `Block` from `unverified` to `live` root after verification passes. Given that we have a persisted `Block` as a file under the `unverified` root, after verification for the said `Block` passes, the `BlockAsLocalFile Persistence` must move the persisted `Block` file from `unverified` root to the `live` root, utilizing the `trie` structure of the `live` root, essentially publishing the `Block` and making it available. | Any `Block` that is persisted under the `unverified` root must be moved to `live` once verification passes (essentially publishing it as available).                                                                                                                                                                                                                                                                                                                                                                                                         | Ensure that `Block` with `BlockNumber`=12345L is persisted as file at `/unverified/0000000000000012345.blk` and is not published to `live` nor archived in `archive`, then verification must publish a successful verification result for `Block` with `BlockNumber`=12345L.                     | Regular file: `0000000000000012345.blk` with location: `/unverified/0000000000000012345.blk` is no longer present, but is now moved as a regular file at `/live/0/0/0/0/0/0/0/0/0/0/0/0/0/0/1/2/3/4/0000000000000012345.blk`.                                                                                                                            |         N         |
| E2ETC_BLFP_0007 | `Verify Contnet of Block Persisted Under Unverified Root After Move to Live Root`  | `BlockAsLocalFile Persistence` will move a `Block` from `unverified` to `live` root after verification passes. After the move happens, the content of the now live file must be the same compared to pre-move.                                                                                                                                                                                                                                                                 | Any `Block` that is persisted under the `unverified` root must be moved to `live` once verification passes (essentially publishing it as available) and the content of the moved `Block` must be the same as pre-move.                                                                                                                                                                                                                                                                                                                                       | Ensure that `Block` with `BlockNumber`=12345L is persisted as file at `/unverified/0000000000000012345.blk` and is not published to `live` nor archived in `archive`, then verification must publish a successful verification result for `Block` with `BlockNumber`=12345L.                     | Regular file: `0000000000000012345.blk` with location: `/unverified/0000000000000012345.blk` is no longer present, but is now moved as a regular file at `/live/0/0/0/0/0/0/0/0/0/0/0/0/0/0/1/2/3/4/0000000000000012345.blk` and content of the moved file are the same as pre-move.                                                                     |         N         |
| E2ETC_BLFP_0008 | `Verify Cleanup of Unverified Root at System Startup`                              | `Block` files under `unverified` that may exist during system startup must be all deleted as they are deemed untrustworthy. It is not possible to assert the state thereof.                                                                                                                                                                                                                                                                                                    | Any `Block` files persisted under the `unverified` root must be deleted during system startup. The `unverified` root must be completely empty by the time the system is up and running, ready to operate.                                                                                                                                                                                                                                                                                                                                                    | Ensure that an arbitrary amount of `Block` files are present in the `unverified` root, then proceed to startup the system.                                                                                                                                                                       | `unverified` root is completely empty by the time the system is started and ready to operate.                                                                                                                                                                                                                                                            |         N         |
| E2ETC_BLFP_0009 | `Verify Discoverability of Block Persisted Under Live Root`                        | A `Block` file that has been moved (published) to `live` storage is now deemed available, meaning that it is persisted and verified. Such files can be discovered.                                                                                                                                                                                                                                                                                                             | Any `Block` that is made available (published) as a file under the `live` root, is able to be read/queried the contents thereof using the `Block Node`'s APIs.                                                                                                                                                                                                                                                                                                                                                                                               | Ensure that `Block` with `BlockNumber`=12345L is persisted as file at `/live/0/0/0/0/0/0/0/0/0/0/0/0/0/0/1/2/3/4/0000000000000012345.blk` and is not present in `unverified` nor archived in `archive`, then send `long` blockNumber=12345L as parameter to the block reader.                    | Block reader should return the queried `Block`.                                                                                                                                                                                                                                                                                                          |         N         |
| E2ETC_BLFP_0010 | `Verify Immutable Block Moved Under Live Root`                                     | A `Block` file that has been moved (published) to `live` storage is now deemed available, but also final. Once published to `live`, it must not be possible to overwrite this file - accept `BlockItem`s via the input `BlockStream` for any `Block` that has been published/moved to `live`. Essentially, any attempt at overwriting must be seen as `DUPLICATE_BLOCK`.                                                                                                       | Any `Block` that is made available (published) as a file under the `live` root, is immutable and cannot be overwritten as it is deemed final. Any input with `BlockItem`s for any `Block` that has been published to `live` must result in a `DUPLICATE_BLOCK`.                                                                                                                                                                                                                                                                                              | Ensure that `Block` with `BlockNumber`=12345L is persisted as file at `/live/0/0/0/0/0/0/0/0/0/0/0/0/0/0/1/2/3/4/0000000000000012345.blk` and is not present in `unverified` nor archived in `archive`, then send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service. | Publisher must expect a `PERSISTENCE_FAILURE` response.                                                                                                                                                                                                                                                                                                  |         N         |
| E2ETC_BLFP_0011 | `Verify Persistence Failure if Bad Block Number is Submitted`                      | A publisher of the `BlockStream` must expect a `PERSISTENCE_FAILURE` response if it submits a `BlockHeader` that contains a `BlockNumber` that is strictly negative. This is a `BAD_BLOCK_NUMBER` persistence result.                                                                                                                                                                                                                                                          | A publisher of the `BlockStream` will receive a `PERSISTENCE_FAILURE` response if it publishes a `BlockHeader` with a strictly negative `BlockNumber`.                                                                                                                                                                                                                                                                                                                                                                                                       | Send `BlockItem`s for `Block` with `BlockNumber`=-12345L to the persistence service.                                                                                                                                                                                                             | Publisher must expect a `PERSISTENCE_FAILURE` response.                                                                                                                                                                                                                                                                                                  |         N         |
| E2ETC_BLFP_0012 | `Verify Persistence Failure in Case of an Incomplete Block`                        | A publisher of the `BlockStream` must expect a `PERSISTENCE_FAILURE` response if it submits a `BlockHeader` before it submits the expected `BlockProof` that would denote the end of the current streamed `Block`.                                                                                                                                                                                                                                                             | A publisher of the `BlockStream` will receive a `PERSISTENCE_FAILURE` response if it publishes a `BlockHeader` before publishing the expected `BlockProof` of the current streamed `Block` which would denote the end of the current `Block`.                                                                                                                                                                                                                                                                                                                | Send half of the `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service, then send `BlockHeader` for `Block` with `BlockNumber`=12346L.                                                                                                                                   | Publisher must expect a `PERSISTENCE_FAILURE` response.                                                                                                                                                                                                                                                                                                  |         N         |
| E2ETC_BLFP_0013 | `Verify Persistence Failure in Case of an IO Issue`                                | A publisher of the `BlockStream` must expect a `PERSISTENCE_FAILURE` response if an IO issue occurs while the actual persistence of the current `Block` is happening.                                                                                                                                                                                                                                                                                                          | A publisher of the `BlockStream` will receive a `PERSISTENCE_FAILURE` response if there is an IO issue during the actual persistence of the current `Block`.                                                                                                                                                                                                                                                                                                                                                                                                 | Send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service, then an IO issue occurs during writing of the file.                                                                                                                                                          | Publisher must expect a `PERSISTENCE_FAILURE` response.                                                                                                                                                                                                                                                                                                  |         N         |
| E2ETC_BLFP_0014 | `Verify Successful Block Persistence`                                              | A publisher of the `BlockStream` must expect a successful acknowledgement if the persistence and verification of the current streamed `Block` succeed.                                                                                                                                                                                                                                                                                                                         | A publisher of the `BlockStream` will receive a successful acknowledgement if the persistence and verification of the current streamed `Block` succeed.                                                                                                                                                                                                                                                                                                                                                                                                      | Send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service, then persist in `unverified`, then verification publishes a successful verification result for the input `Block`, then persistence moves/publishes the `Block` in `live`.                                    | Publisher must expect a successful acknowledgement.                                                                                                                                                                                                                                                                                                      |         N         |
| E2ETC_BLFP_0015 | `Verify Successful Archival of Blocks`                                             | `BlockAsLocalFile Persistence` will periodically (based on passed persistence threshold) archive `Block`s in groups of configurable size. Once the archive threshold passes, the `Block Node` has to archive the next group in line.                                                                                                                                                                                                                                           | Given the `archiveGroupSize` is set to 10 and that we have all `Block`s persisted as files and published under the `live` root for `Block`s with `BlockNumber`s between 0L and 19L both included, when we now receive as input the `BlockItems` for `Block` with `BlockNumber` 20L, then persist, verify and publish it to `live`, we expect that all the `Block`s with `BlockNumber`s between 0L and 10L will be zipped to `/archive/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0.zip` and a link `/live/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0.zip` will be available. | Ensure that `archiveGroupSize` is 10, `Block`s with `BlockNumber`s between 0L and 19L both included are persisted, verified and published in `live`, then send `BlockItem`s for `Block` with `BlockNumber` = 20L and persist, verify and publish it to `live`.                                   | Link: `/live/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0.zip` exists in the place of where the files for `Block`s with `BlockNumber`s between 0L and 9L, both included, must be residing, regular file: `/archive/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0/0.zip` exists that contains all the files for `Block`s with `BlockNumber`s between 0L and 9L, both included. |         N         |
| E2ETC_BLFP_0016 | `Verify Discoverability of Block Persisted Under Archive Root`                     | A `Block` file that has been archived must be readable by using the system's APIs. Archived `Block`s are available, final and discoverable.                                                                                                                                                                                                                                                                                                                                    | Any `Block` that is archived is discoverable in the sense that it is deemed available and can be read/queried via the `Block Node`'s APIs.                                                                                                                                                                                                                                                                                                                                                                                                                   | Ensure that `Block` with `BlockNumber`=12345L is archived and is not available in `live` nor `unverified`, then send `long` blockNumber=12345L as parameter to the block reader.                                                                                                                 | Block reader should return the queried `Block`.                                                                                                                                                                                                                                                                                                          |         N         |
| E2ETC_BLFP_0017 | `Verify Immutable Archived Block`                                                  | A `Block` that has been archived is now deemed immutable and final. It must not be possible to overwrite any archived file - accept `BlockItem`s as input for any `Block` that has been archived. Essentially, any attempt at overwriting must be seen as `DUPLICATE_BLOCK`.                                                                                                                                                                                                   | Any `Block` that is archived is deemed final and immutable. It must not be possible to overwrite the file.                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Ensure that `Block` with `BlockNumber`=12345L is archived and is not available in `live` nor `unverified`, then send `BlockItem`s for `Block` with `BlockNumber`=12345L to the persistence service.                                                                                              | Publisher must expect a `PERSISTENCE_FAILURE` response.                                                                                                                                                                                                                                                                                                  |         N         |
